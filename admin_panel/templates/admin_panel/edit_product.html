{% extends 'admin_panel/base.html' %}
{% load custom_filters %}

{% block content %}

<div class="max-w-xl mx-auto p-6 bg-white shadow-md rounded-md mt-10">
  <h2 class="text-2xl font-semibold mb-4 text-center">Edit Product</h2>

  {% if messages %}
  {% for message in messages %}
  <p class="text-sm text-{{ message.tags }}-600 mb-2">{{ message }}</p>
  {% endfor %}
  {% endif %}

  <form method="post" enctype="multipart/form-data" class="space-y-4">
    {% csrf_token %}

    <!-- Name -->
    <label for="name" class="block font-semibold">Product Name</label>
    <input type="text" id="name" name="name" value="{{ product.name }}" placeholder="Product Name"
      class="w-full px-4 py-2 border rounded" required />

    <!-- Category -->
    <label for="category" class="block font-semibold">Category</label>
    <select name="category" id="category" class="w-full px-4 py-2 border rounded" required>
      {% for cat in categories %}
      <option value="{{ cat.id }}" {% if cat.id|equals_id:product.category.id %}selected{% endif %}>
        {{ cat.name }}
      </option>
      {% endfor %}
    </select>




    <!-- Description -->
    <label for="description" class="block font-semibold">Description</label>
    <textarea name="description" id="description" placeholder="Product Description"
      class="w-full px-4 py-2 border rounded" rows="4" required>{{ product.description }}</textarea>
    <div class="grid grid-cols-2 gap-4">
      <div>
        <label class="block mb-1 font-medium">Min Age (months)</label>
        <input type="number" name="min_age" min="0" max="36" class="w-full px-4 py-2 border rounded"
          value="{{ product.min_age }}" />
      </div>
      <div>
        <label class="block mb-1 font-medium">Max Age (months)</label>
        <input type="number" name="max_age" min="0" max="36" class="w-full px-4 py-2 border rounded"
          value="{{ product.max_age }}" />
      </div>
    </div>

    <div>
      <label class="block mb-1 font-medium">Gender</label>
      <select name="gender" class="w-full px-4 py-2 border rounded">
        <option value="Unisex" {% if product.gender|equals_id:"Unisex" %}selected{% endif %}>Unisex</option>
        <option value="Male" {% if product.gender|equals_id:"Male" %}selected{% endif %}>Male</option>
        <option value="Female" {% if product.gender|equals_id:"Female" %}selected{% endif %}>Female</option>
      </select>
    </div>


    <!-- Price -->
    <label for="price" class="block font-semibold">Price (â‚¹)</label>
    <input type="number" id="price" name="price" step="0.01" value="{{ product.price }}" placeholder="Price"
      class="w-full px-4 py-2 border rounded" required />

    <!-- Stock -->
    <label for="stock" class="block font-semibold">Stock</label>
    <input type="number" id="stock" name="stock" value="{{ product.stock }}" placeholder="Stock"
      class="w-full px-4 py-2 border rounded" required />

    <!-- Status -->
    <label for="status" class="block font-semibold">Status</label>
    <select name="status" id="status" class="w-full px-4 py-2 border rounded" required>
      <option value="Active" {% if product.status|equals_id:"Active" %}selected{% endif %}>Active</option>
      <option value="Inactive" {% if product.status|equals_id:"Inactive" %}selected{% endif %}>Inactive</option>
    </select>

    <!-- Current Images -->
    <h4 class="font-semibold mt-4">Current Images:</h4>
    <div class="flex gap-4 my-2 flex-wrap">
      {% for img in product.images.all %}
      <img src="{{ img.image.url }}" class="w-24 h-24 object-cover rounded shadow" />
      {% empty %}
      <p class="text-gray-500">No images uploaded.</p>
      {% endfor %}
    </div>

    <!-- Upload New Images (Cropper.js) -->
    <label class="block font-semibold">Upload New Images (optional, will replace all images)</label>
    <input type="file" id="imageInput" accept="image/*" class="w-full px-4 py-2 border rounded mb-2" />
    <div id="cropperContainer" class="w-64 h-64 mx-auto mb-2 hidden">
      <img id="imagePreview" class="object-contain w-full h-full rounded shadow" />
    </div>
    <div class="flex gap-2 mb-2">
      <button id="addCroppedBtn" type="button" class="bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700">Add
        Cropped Image</button>
    </div>
    <div id="croppedImagesPreview" class="flex gap-4 mb-2"></div>
    <div id="croppedInputs"></div>
    <p class="text-sm text-gray-500">If you upload new images, you must crop and add exactly 3 images. Otherwise, leave
      blank to keep current images.</p>

    <!-- Submit -->
    <div class="flex justify-end">
      <button type="submit" class="bg-blue-600 text-white px-6 py-2 rounded hover:bg-blue-700">
        Save Changes
      </button>
    </div>
  </form>
</div>
{% endblock %}

<!-- Add in <head> -->
<link href="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.13/cropper.min.css" rel="stylesheet" />
<!-- Before </body> -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.13/cropper.min.js"></script>

<script>
  let cropper;
  let croppedImages = [];
  const imageInput = document.getElementById('imageInput');
  const imagePreview = document.getElementById('imagePreview');
  const cropperContainer = document.getElementById('cropperContainer');
  const addCroppedBtn = document.getElementById('addCroppedBtn');
  const croppedImagesPreview = document.getElementById('croppedImagesPreview');
  const croppedInputs = document.getElementById('croppedInputs');
  const productForm = document.querySelector('form');

  imageInput.addEventListener('change', function (e) {
    const file = e.target.files[0];
    if (file) {
      cropperContainer.classList.remove('hidden');
      const url = URL.createObjectURL(file);
      imagePreview.src = url;
      if (cropper) cropper.destroy();
      cropper = new Cropper(imagePreview, {
        aspectRatio: 1,
        viewMode: 1,
        autoCropArea: 1,
      });
    }
  });

  addCroppedBtn.addEventListener('click', function (e) {
    e.preventDefault();
    if (cropper && croppedImages.length < 3) {
      cropper.getCroppedCanvas({ width: 600, height: 600 }).toBlob(function (blob) {
        const file = new File([blob], `cropped${croppedImages.length + 1}.jpg`, { type: "image/jpeg" });
        croppedImages.push(file);

        // Preview
        const imgElem = document.createElement('img');
        imgElem.src = URL.createObjectURL(file);
        imgElem.className = "w-20 h-20 object-cover rounded border";
        croppedImagesPreview.appendChild(imgElem);

        // Hidden input for form
        const inputElem = document.createElement('input');
        inputElem.type = "file";
        inputElem.name = "images";
        inputElem.files = (function () {
          const dt = new DataTransfer();
          dt.items.add(file);
          return dt.files;
        })();
        inputElem.className = "hidden";
        croppedInputs.appendChild(inputElem);

        // Reset for next image
        cropper.destroy();
        cropperContainer.classList.add('hidden');
        imageInput.value = "";
      }, 'image/jpeg', 0.95);
    }
  });

  // Prevent form submission unless 3 images are added if any new images are uploaded
  productForm.addEventListener('submit', function (e) {
    if (croppedImages.length !== 0 && croppedImages.length !== 3) {
      e.preventDefault();
      alert("Please crop and add exactly 3 images if you are uploading new images.");
    }
  });
</script>