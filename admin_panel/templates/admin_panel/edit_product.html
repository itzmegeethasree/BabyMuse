{% extends 'admin_panel/base.html' %}
{% load static %}

{% block content %}
<div class="max-w-6xl mx-auto p-6 bg-white rounded shadow">
  <h2 class="text-xl font-bold mb-6">Edit Product</h2>

  <form method="POST" enctype="multipart/form-data">
    {% csrf_token %}

    <!-- Product Info -->
    <div class="grid grid-cols-2 gap-4 mb-6">
      {% for field in product_form %}
      <div>
        <label class="block font-medium">{{ field.label }}</label>
        {{ field }}
        {% if field.errors %}
        <p class="text-red-500 text-sm">{{ field.errors.0 }}</p>
        {% endif %}
      </div>
      {% endfor %}
    </div>

    <!-- Images -->
    <div class="mb-6">
      <h3 class="text-lg font-semibold mb-2">Product Images</h3>
      <input type="file" id="imageInput" accept="image/*" multiple class="block w-full border p-2 rounded">

      <!-- Existing Images -->
      {% if existing_images %}
      <div class="grid grid-cols-3 gap-4 mt-4" id="existingImageGrid">
        {% for img in existing_images %}
        <div class="relative">
          <img src="{{ img.image.url }}" class="w-full h-40 object-contain rounded shadow border" />
          <input type="hidden" name="keep_image_ids" value="{{ img.id }}">
          <button type="button"
            class="absolute top-1 right-1 bg-red-600 text-white text-xs px-2 py-0.5 rounded delete-existing"
            data-id="{{ img.id }}">
            ✕
          </button>
        </div>
        {% endfor %}
      </div>
      {% endif %}

      <!-- Cropping Area for New Images -->
      <div id="cropPreviewArea" class="grid grid-cols-3 gap-4 mt-4"></div>
      <input type="hidden" name="cropped_images_data" id="croppedImagesData">
      <p class="text-gray-500 text-sm mt-1">Upload and crop new image(s) if needed.</p>
    </div>

    <!-- Variants -->
    <div class="mb-6">
      <h3 class="text-lg font-semibold mb-2">Variants</h3>
      <table class="w-full mt-2 border text-sm">
        <thead class="bg-gray-100">
          <tr>
            <th class="p-2">Size</th>
            <th class="p-2">Color</th>
            <th class="p-2">SKU</th>
            <th class="p-2">Price</th>
            <th class="p-2">Stock</th>
            <th class="p-2">Remove</th>
          </tr>
        </thead>
        <tbody id="variantTable">
          {% for v in existingVariants %}
          <tr>
            <td class="p-1">{{ v.size_label }}
              <input type="hidden" name="variants[{{ forloop.counter0 }}][size]" value="{{ v.size_id }}">
            </td>
            <td class="p-1">{{ v.color_label }}
              <input type="hidden" name="variants[{{ forloop.counter0 }}][color]" value="{{ v.color_id }}">
            </td>
            <td class="p-1"><input type="text" name="variants[{{ forloop.counter0 }}][sku]" value="{{ v.sku }}"
                class="border p-1 w-full" /></td>
            <td class="p-1"><input type="number" step="0.01" name="variants[{{ forloop.counter0 }}][price]"
                value="{{ v.price }}" class="border p-1 w-full" /></td>
            <td class="p-1"><input type="number" name="variants[{{ forloop.counter0 }}][stock]" value="{{ v.stock }}"
                class="border p-1 w-full" /></td>
            <td class="p-1"><button type="button" onclick="this.closest('tr').remove()">❌</button></td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>

    <button type="submit" class="w-full bg-green-600 text-white py-2 rounded">Update Product</button>
  </form>
</div>

<!-- Scripts -->
<link href="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.13/cropper.min.css" rel="stylesheet" />
<script src="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.13/cropper.min.js"></script>

<script>
  document.addEventListener('DOMContentLoaded', () => {
    const imageInput = document.getElementById('imageInput');
    const previewArea = document.getElementById('cropPreviewArea');
    const form = document.querySelector('form');
    let croppedCanvases = [];

    imageInput?.addEventListener('change', function (e) {
      const files = e.target.files;
      previewArea.innerHTML = '';
      croppedCanvases = [];

      Array.from(files).forEach((file, index) => {
        const reader = new FileReader();
        reader.onload = function (event) {
          const wrapper = document.createElement('div');
          wrapper.className = 'relative bg-white p-2 rounded shadow';

          const img = document.createElement('img');
          img.src = event.target.result;
          img.className = 'w-full h-48 object-contain';

          const cropBtn = document.createElement('button');
          cropBtn.innerText = 'Crop & Preview';
          cropBtn.className = 'mt-2 bg-blue-600 text-white text-xs px-2 py-1 rounded';
          cropBtn.type = 'button';

          const preview = document.createElement('img');
          preview.className = 'w-full mt-2 rounded shadow';
          preview.style.display = 'none';

          wrapper.appendChild(img);
          wrapper.appendChild(cropBtn);
          wrapper.appendChild(preview);
          previewArea.appendChild(wrapper);

          const cropper = new Cropper(img, {
            aspectRatio: 1,
            viewMode: 1,
          });

          cropBtn.onclick = () => {
            const canvas = cropper.getCroppedCanvas({ width: 600, height: 600 });
            preview.src = canvas.toDataURL('image/jpeg');
            preview.style.display = 'block';
            croppedCanvases[index] = canvas;
          };
        };
        reader.readAsDataURL(file);
      });
    });

    form?.addEventListener('submit', function (e) {
      e.preventDefault();
      const croppedImagesData = [];
      const filtered = croppedCanvases.filter(Boolean);
      if (!filtered.length) return form.submit();

      let completed = 0;
      filtered.forEach((canvas) => {
        canvas.toBlob(function (blob) {
          const reader = new FileReader();
          reader.onloadend = function () {
            croppedImagesData.push(reader.result);
            completed++;
            if (completed === filtered.length) {
              document.getElementById('croppedImagesData').value = JSON.stringify(croppedImagesData);
              form.submit();
            }
          };
          reader.readAsDataURL(blob);
        }, 'image/jpeg');
      });
    });

    document.addEventListener('click', function (e) {
      if (e.target.classList.contains('delete-existing')) {
        const wrapper = e.target.closest('div.relative');
        wrapper.querySelector('input[name="keep_image_ids"]')?.remove();
        wrapper.remove();
      }
    });
  });
  document.addEventListener('click', function (e) {
    if (e.target.classList.contains('delete-existing')) {
      const container = e.target.closest('div.relative');
      const input = container.querySelector('input[name="keep_image_ids"]');
      if (input) input.remove(); // Prevent resave
      container.remove(); // Remove visual block
    }
  });


</script>
{% endblock %}