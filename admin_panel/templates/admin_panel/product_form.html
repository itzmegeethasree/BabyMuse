{% extends 'admin_panel/base.html' %}
{% load static %}

{% block content %}
<div class="max-w-6xl mx-auto p-6 bg-white rounded shadow">
  <h2 class="text-xl font-bold mb-6">
    {% if is_edit %}Edit Product{% else %}Add New Product{% endif %}
  </h2>
  <form method="POST" enctype="multipart/form-data">
    {% csrf_token %}

    <!-- Product Info -->
    <div class="grid grid-cols-2 gap-4 mb-6">
      {% for field in product_form %}
      <div>
        <label class="block font-medium mb-1 text-gray-700">{{ field.label }}</label>
        {{ field }}
        {% if field.errors %}
        <p class="text-red-500 text-xs mt-1">{{ field.errors.0 }}</p>
        {% endif %}
      </div>
      {% endfor %}
    </div>

    <!-- Images -->
    <div class="mb-6">
      <h3 class="text-lg font-semibold mb-2">Product Images</h3>
      {% if is_edit %}
      <div class="flex gap-4 mb-2 flex-wrap">
        {% for img in product.images.all %}
        <div class="relative">
          <img src="{{ img.image.url }}" class="w-24 h-24 object-cover rounded shadow" />
          <input type="checkbox" name="keep_image_ids" value="{{ img.id }}" checked class="absolute top-1 left-1">
          <button type="button"
            class="delete-existing absolute top-1 right-1 bg-red-500 text-white rounded px-2 py-1 text-xs"
            onclick="this.closest('div').remove();">Delete</button>
        </div>
        {% endfor %}
      </div>
      <p class="text-gray-500 text-sm mb-2">Uncheck or delete images you don't want to keep. You can also upload and
        crop new images below.</p>
      {% endif %}
      <input type="file" id="imageInput" accept="image/*" multiple
        class="block w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-400">
      <div id="cropPreviewArea" class="grid grid-cols-3 gap-4 mt-4"></div>
      <input type="hidden" name="cropped_images_data" id="croppedImagesData">
      <p class="text-gray-500 text-sm mt-1">You can keep existing images, add new cropped images, or both. Total images
        must be 1–3.</p>
    </div>

    <!-- Variants -->
    <div class="mb-6">
      <h3 class="text-lg font-semibold mb-2">Variants</h3>
      <div class="grid grid-cols-2 gap-4 mb-4">
        <div>
          <label class="block text-sm font-medium mb-1">Select Sizes</label>
          <select id="variantSizes"
            class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-400"
            multiple>
            {% for size in size_options %}
            <option value="{{ size.id }}">{{ size.value }}</option>
            {% endfor %}
          </select>
        </div>
        <div>
          <label class="block text-sm font-medium mb-1">Select Colors</label>
          <select id="variantColors" class="w-full border rounded p-2" multiple>
            {% for color in color_options %}
            <option value="{{ color.id }}">{{ color.value }}</option>
            {% endfor %}
          </select>
        </div>
      </div>
      <button type="button" id="generateVariantsBtn" class="bg-blue-500 text-white px-4 py-1 rounded">Generate</button>
      <table class="w-full mt-4 border text-sm">
        <thead class="bg-gray-100">
          <tr>
            <th class="p-2">Size</th>
            <th class="p-2">Color</th>
            <th class="p-2">SKU</th>
            <th class="p-2">Price</th>
            <th class="p-2">Stock</th>
            <th class="p-2">Remove</th>
          </tr>
        </thead>
        <tbody id="variantTable">
          {% if is_edit and existingVariants %}
          {% for v in existingVariants %}
          <tr>
            <td class="p-1">{{ v.size_label }}<input type="hidden" name="variants[{{ forloop.counter0 }}][size]"
                value="{{ v.size_id }}" /></td>
            <td class="p-1">{{ v.color_label }}<input type="hidden" name="variants[{{ forloop.counter0 }}][color]"
                value="{{ v.color_id }}" /></td>
            <td class="p-1"><input type="text" name="variants[{{ forloop.counter0 }}][sku]" value="{{ v.sku }}"
                class="border p-1 w-full" /></td>
            <td class="p-1"><input type="number" name="variants[{{ forloop.counter0 }}][price]" step="0.01"
                value="{{ v.price }}" class="border p-1 w-full" required /></td>
            <td class="p-1"><input type="number" name="variants[{{ forloop.counter0 }}][stock]" value="{{ v.stock }}"
                class="border p-1 w-full" required /></td>
            <td class="p-1">
              <button type="button" onclick="removeVariantRow(this)">❌</button>
            </td>
            <input type="hidden" name="variants[{{ forloop.counter0 }}][variant_id]" value="{{ v.id }}">
          </tr>
          {% endfor %}
          {% endif %}
        </tbody>
      </table>
    </div>

    <button type="submit" class="w-full bg-green-600 text-white py-2 rounded hover:bg-green-700 transition">
      {% if is_edit %}Update Product{% else %}Submit Product{% endif %}
    </button>
  </form>
</div>

<!-- CropperJS -->
<link href="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.13/cropper.min.css" rel="stylesheet" />
<script src="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.13/cropper.min.js"></script>

<script>
  let cropInstances = [], croppedCanvases = [], rowIndex = document.querySelectorAll('#variantTable tr').length;

  document.addEventListener('DOMContentLoaded', () => {
    const imageInput = document.getElementById('imageInput');
    const previewArea = document.getElementById('cropPreviewArea');
    const form = document.querySelector('form');

    imageInput?.addEventListener('change', function (e) {
      const files = e.target.files;
      previewArea.innerHTML = '';
      cropInstances = [];
      croppedCanvases = [];

      Array.from(files).forEach((file, index) => {
        const reader = new FileReader();
        reader.onload = function (event) {
          const wrapper = document.createElement('div');
          wrapper.className = 'relative bg-white p-2 rounded shadow';

          const img = document.createElement('img');
          img.src = event.target.result;
          img.className = 'w-full h-48 object-contain';

          const preview = document.createElement('img');
          preview.className = 'w-full mt-2 rounded shadow';
          preview.style.display = 'none';

          const cropBtn = document.createElement('button');
          cropBtn.innerText = "Crop & Preview";
          cropBtn.type = "button";
          cropBtn.className = 'mt-2 bg-blue-600 text-white text-xs px-2 py-1 rounded';

          wrapper.appendChild(img);
          wrapper.appendChild(cropBtn);
          wrapper.appendChild(preview);
          previewArea.appendChild(wrapper);

          const cropper = new Cropper(img, {
            aspectRatio: 1,
            viewMode: 1,
          });

          cropBtn.onclick = () => {
            const canvas = cropper.getCroppedCanvas({ width: 600, height: 600 });
            preview.src = canvas.toDataURL('image/jpeg');
            preview.style.display = 'block';
            croppedCanvases[index] = canvas;
          };

          cropInstances.push(cropper);
        };
        reader.readAsDataURL(file);
      });
    });

    form?.addEventListener('submit', function (e) {
      const keepImageInputs = form.querySelectorAll('input[name="keep_image_ids"]:checked');
      const filtered = croppedCanvases.filter(Boolean);
      const totalImages = keepImageInputs.length + filtered.length;

      // Validation
      if (totalImages === 0) {
        e.preventDefault();
        alert("At least one product image must be kept or uploaded.");
        return;
      }
      if (totalImages > 3) {
        e.preventDefault();
        alert("You cannot have more than 3 images in total.");
        return;
      }
      // If no new images, submit as usual
      if (filtered.length === 0) return;

      // If new images, encode and submit
      e.preventDefault();
      const croppedImagesData = [];
      let completed = 0;
      filtered.forEach((canvas) => {
        canvas.toBlob(function (blob) {
          const reader = new FileReader();
          reader.onloadend = function () {
            croppedImagesData.push(reader.result);
            completed++;
            if (completed === filtered.length) {
              document.getElementById('croppedImagesData').value = JSON.stringify(croppedImagesData);
              form.submit();
            }
          };
          reader.readAsDataURL(blob);
        }, 'image/jpeg');
      });
    });
  });

  function generateVariantRows() {
    const sizes = Array.from(document.querySelectorAll('#variantSizes option:checked'));
    const colors = Array.from(document.querySelectorAll('#variantColors option:checked'));
    const tbody = document.getElementById('variantTable');
    const productName = document.querySelector('input[name="name"]')?.value || "prod";

    if (!sizes.length || !colors.length) {
      alert("Please select at least one size and one color.");
      return;
    }

    // Collect existing combinations (size_id-color_id) from Django-rendered rows
    const existingCombos = new Set();
    Array.from(tbody.querySelectorAll('tr')).forEach(row => {
      const sizeInput = row.querySelector('input[name*="[size]"]');
      const colorInput = row.querySelector('input[name*="[color]"]');
      if (sizeInput && colorInput) {
        existingCombos.add(`${sizeInput.value}-${colorInput.value}`);
      }
    });

// Don't remove previously generated rows — just skip duplicates
const generatedCombos = new Set();
Array.from(tbody.querySelectorAll('tr')).forEach(row => {
  const sizeInput = row.querySelector('input[name*="[size]"]');
  const colorInput = row.querySelector('input[name*="[color]"]');
  if (sizeInput && colorInput) {
    generatedCombos.add(`${sizeInput.value}-${colorInput.value}`);
  }
});
    let rowIndex = tbody.querySelectorAll('tr').length;
    sizes.forEach(size => {
      colors.forEach(color => {
        const comboKey = `${size.value}-${color.value}`;
        if (generatedCombos.has(comboKey)) return;

        const sku = generateSKU(productName, size.textContent, color.textContent);

        const row = document.createElement('tr');
        row.className = 'generated-variant-row';
        row.innerHTML = `
          <td class="p-1">${size.textContent}<input type="hidden" name="variants[${rowIndex}][size]" value="${size.value}" /></td>
          <td class="p-1">${color.textContent}<input type="hidden" name="variants[${rowIndex}][color]" value="${color.value}" /></td>
          <td class="p-1"><input type="text" name="variants[${rowIndex}][sku]" value="${sku}" class="border p-1 w-full" /></td>
          <td class="p-1"><input type="number" name="variants[${rowIndex}][price]" step="0.01" class="border p-1 w-full" required /></td>
          <td class="p-1"><input type="number" name="variants[${rowIndex}][stock]" class="border p-1 w-full" required /></td>
          <td class="p-1"><button type="button" onclick="this.closest('tr').remove()">❌</button></td>
        `;
        tbody.appendChild(row);
        rowIndex++;
      });
    });
  }

  document.getElementById('generateVariantsBtn')?.addEventListener('click', generateVariantRows);

  function removeVariantRow(btn) {
    const row = btn.closest('tr');
    row.parentNode.removeChild(row);
  }

  function generateSKU(productName, sizeText, colorText) {
    // Simple slugify: lowercase, replace spaces, take first 6 chars
    const base = productName.toLowerCase().replace(/\s+/g, '-').slice(0, 6);
    const sizePart = sizeText.slice(0, 2).toUpperCase();
    const colorPart = colorText.slice(0, 2).toUpperCase();
    return `${base}-${sizePart}-${colorPart}`;
  }
</script>

{% if product_form.errors %}
<div class="text-red-600 mb-2">
  {% for field, errors in product_form.errors.items %}
  <strong>{{ field|capfirst }}:</strong> {{ errors|join:", " }}<br>
  {% endfor %}
</div>
{% endif %}

{% if variant_forms %}
{% for vform in variant_forms %}
{% if vform.errors %}
<div class="text-red-600 mb-2">
  Variant error:
  {% for field, errors in vform.errors.items %}
  <strong>{{ field|capfirst }}:</strong> {{ errors|join:", " }}<br>
  {% endfor %}
</div>
{% endif %}
{% endfor %}
{% endif %}
{% endblock %}