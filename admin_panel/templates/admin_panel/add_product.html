{% extends 'admin_panel/base.html' %}
{% load static %}

{% block content %}
<div class="max-w-6xl mx-auto p-6 bg-white rounded shadow">
  <h2 class="text-xl font-bold mb-6">Add New Product</h2>

  <form method="POST" enctype="multipart/form-data">
    {% csrf_token %}

    <!-- Product Info -->
    <div class="grid grid-cols-2 gap-4 mb-6">
      {% for field in product_form %}
      <div>
        <label class="block font-medium">{{ field.label }}</label>
        {{ field }}
        {% if field.errors %}
        <p class="text-red-500 text-sm">{{ field.errors.0 }}</p>
        {% endif %}
      </div>
      {% endfor %}
    </div>

    <!-- Images -->
    <div class="mb-6">
      <h3 class="text-lg font-semibold mb-2">Product Images</h3>
      <input type="file" id="imageInput" accept="image/*" multiple class="block w-full border p-2 rounded">
      <div id="cropPreviewArea" class="grid grid-cols-3 gap-4 mt-4"></div>
      <input type="hidden" name="cropped_images_data" id="croppedImagesData">
      <p class="text-gray-500 text-sm mt-1">Upload and crop at least 3 images.</p>
    </div>

    <!-- Variants -->
    <div class="mb-6">
      <h3 class="text-lg font-semibold mb-2">Variants</h3>
      <div class="grid grid-cols-2 gap-4 mb-4">
        <div>
          <label class="block text-sm font-medium mb-1">Select Sizes</label>
          <select id="variantSizes" class="w-full border rounded p-2" multiple>
            {% for size in size_options %}
            <option value="{{ size.id }}">{{ size.value }}</option>
            {% endfor %}
          </select>
        </div>
        <div>
          <label class="block text-sm font-medium mb-1">Select Colors</label>
          <select id="variantColors" class="w-full border rounded p-2" multiple>
            {% for color in color_options %}
            <option value="{{ color.id }}">{{ color.value }}</option>
            {% endfor %}
          </select>
        </div>
      </div>
      <button type="button" id="generateVariantsBtn" class="bg-blue-500 text-white px-4 py-1 rounded">Generate</button>
      <table class="w-full mt-4 border text-sm">
        <thead class="bg-gray-100">
          <tr>
            <th class="p-2">Size</th>
            <th class="p-2">Color</th>
            <th class="p-2">SKU</th>
            <th class="p-2">Price</th>
            <th class="p-2">Stock</th>
            <th class="p-2">Remove</th>
          </tr>
        </thead>
        <tbody id="variantTable"></tbody>
      </table>
    </div>

    <button type="submit" class="w-full bg-green-600 text-white py-2 rounded">Submit Product</button>
  </form>
</div>

<!-- CropperJS -->
<link href="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.13/cropper.min.css" rel="stylesheet" />
<script src="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.13/cropper.min.js"></script>

<script>
  let cropInstances = [], croppedCanvases = [], rowIndex = 0;

  document.addEventListener('DOMContentLoaded', () => {
    const imageInput = document.getElementById('imageInput');
    const previewArea = document.getElementById('cropPreviewArea');
    const form = document.querySelector('form');

    imageInput?.addEventListener('change', function (e) {
      const files = e.target.files;
      previewArea.innerHTML = '';
      cropInstances = [];
      croppedCanvases = [];

      Array.from(files).forEach((file, index) => {
        const reader = new FileReader();
        reader.onload = function (event) {
          const wrapper = document.createElement('div');
          wrapper.className = 'relative bg-white p-2 rounded shadow';

          const img = document.createElement('img');
          img.src = event.target.result;
          img.className = 'w-full h-48 object-contain';

          const preview = document.createElement('img');
          preview.className = 'w-full mt-2 rounded shadow';
          preview.style.display = 'none';

          const cropBtn = document.createElement('button');
          cropBtn.innerText = "Crop & Preview";
          cropBtn.type = "button";
          cropBtn.className = 'mt-2 bg-blue-600 text-white text-xs px-2 py-1 rounded';

          wrapper.appendChild(img);
          wrapper.appendChild(cropBtn);
          wrapper.appendChild(preview);
          previewArea.appendChild(wrapper);

          const cropper = new Cropper(img, {
            aspectRatio: 1,
            viewMode: 1,
          });

          cropBtn.onclick = () => {
            const canvas = cropper.getCroppedCanvas({ width: 600, height: 600 });
            preview.src = canvas.toDataURL('image/jpeg');
            preview.style.display = 'block';
            croppedCanvases[index] = canvas;
          };

          cropInstances.push(cropper);
        };
        reader.readAsDataURL(file);
      });
    });

    form?.addEventListener('submit', function (e) {
      e.preventDefault();
      const croppedImagesData = [];

      if (croppedCanvases.filter(Boolean).length < 3) {
        alert("Please crop at least 3 images.");
        return;
      }

      let completed = 0;
      croppedCanvases.forEach((canvas) => {
        if (!canvas) return;
        canvas.toBlob(function (blob) {
          const reader = new FileReader();
          reader.onloadend = function () {
            croppedImagesData.push(reader.result);
            completed++;

            if (completed === croppedCanvases.filter(Boolean).length) {
              document.getElementById('croppedImagesData').value = JSON.stringify(croppedImagesData);
              form.submit();
            }
          };
          reader.readAsDataURL(blob);
        }, 'image/jpeg');
      });
    });
  });

  function generateVariantRows() {
    const sizes = Array.from(document.querySelectorAll('#variantSizes option:checked'));
    const colors = Array.from(document.querySelectorAll('#variantColors option:checked'));
    const tbody = document.getElementById('variantTable');

    if (!sizes.length || !colors.length) {
      alert("Please select at least one size and one color.");
      return;
    }

    sizes.forEach(size => {
      colors.forEach(color => {
        const row = document.createElement('tr');
        row.innerHTML = `
        <td class="p-1">${size.textContent}<input type="hidden" name="variants[${rowIndex}][size]" value="${size.value}" /></td>
        <td class="p-1">${color.textContent}<input type="hidden" name="variants[${rowIndex}][color]" value="${color.value}" /></td>
        <td class="p-1"><input type="text" name="variants[${rowIndex}][sku]" class="border p-1 w-full" /></td>
        <td class="p-1"><input type="number" name="variants[${rowIndex}][price]" step="0.01" class="border p-1 w-full" required /></td>
        <td class="p-1"><input type="number" name="variants[${rowIndex}][stock]" class="border p-1 w-full" required /></td>
        <td class="p-1"><button type="button" onclick="this.closest('tr').remove()">‚ùå</button></td>
      `;
        tbody.appendChild(row);
        rowIndex++;
      });
    });
  }

  document.getElementById('generateVariantsBtn')?.addEventListener('click', generateVariantRows);
</script>
{% endblock %}