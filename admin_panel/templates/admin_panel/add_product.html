{% extends 'admin_panel/base.html' %}
{% load static %}

{% block content %}
<div class="max-w-4xl mx-auto p-6 bg-white rounded shadow">
  <h2 class="text-xl font-bold mb-6">{{ title }}</h2>

  <form method="POST" enctype="multipart/form-data">
    {% csrf_token %}

    <!-- Product Info -->
    <div class="mb-6">
      <h3 class="text-lg font-semibold mb-2">Product Details</h3>
      {% for field in product_form %}
      <div class="mb-4">
        <label class="block font-medium">{{ field.label }}</label>
        {{ field }}
        {% if field.errors %}
        <p class="text-red-500 text-sm">{{ field.errors.0 }}</p>
        {% endif %}
      </div>
      {% endfor %}
    </div>

    <!-- Images -->
    <div class="mb-6">
      <h3 class="text-lg font-semibold mb-2">Product Images</h3>
      <input type="file" id="imageInput" accept="image/*" multiple class="block w-full border p-2 rounded">
      <div id="cropPreviewArea" class="grid grid-cols-3 gap-4 mt-4"></div>
      <input type="hidden" name="cropped_images_data" id="croppedImagesData">
      <p class="text-gray-500 text-sm mt-1">Upload at least 3 images. Cropping will be handled in the frontend.</p>
    </div>

    <!-- Variants -->
    <div>
      <h3 class="text-lg font-semibold mb-2">Variants</h3>
      {{ variant_formset.management_form }}
      {% for form in variant_formset %}
      <div class="border p-4 mb-4 rounded bg-gray-50">
        {% for field in form.visible_fields %}
        <div class="mb-2">
          <label class="block text-sm font-medium">{{ field.label }}</label>
          {{ field }}
          {% if field.errors %}
          <p class="text-red-500 text-sm">{{ field.errors.0 }}</p>
          {% endif %}
        </div>
        {% endfor %}
        {% if form.can_delete %}
        <label class="inline-flex items-center">
          {{ form.DELETE }} <span class="ml-2">Delete Variant</span>
        </label>
        {% endif %}
      </div>
      {% endfor %}
    </div>

    <button type="submit" class="w-full bg-blue-600 text-white py-2 rounded hover:bg-blue-700 mt-4">
      Save Product
    </button>
  </form>
</div><!-- Cropper.js CSS -->
<link href="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.13/cropper.min.css" rel="stylesheet" />

<!-- Cropper.js JS -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.13/cropper.min.js"></script>

<script>
  let cropInstances = [];

  document.getElementById('imageInput').addEventListener('change', function (e) {
    const files = e.target.files;
    const previewArea = document.getElementById('cropPreviewArea');
    previewArea.innerHTML = '';
    cropInstances = [];

    Array.from(files).forEach((file, index) => {
      const reader = new FileReader();
      reader.onload = function (event) {
        const container = document.createElement('div');
        container.classList.add('border', 'p-2');

        const img = document.createElement('img');
        img.src = event.target.result;
        img.classList.add('w-full', 'h-40', 'object-contain');

        container.appendChild(img);
        previewArea.appendChild(container);

        const cropper = new Cropper(img, {
          aspectRatio: 1,
          viewMode: 1,
          cropBoxResizable: true,
          scalable: true,
        });

        cropInstances.push(cropper);
      };
      reader.readAsDataURL(file);
    });
  });

  // On form submit, convert cropped images to blobs and pass them
  document.querySelector('form').addEventListener('submit', function (e) {
    e.preventDefault();

    const croppedImagesData = [];

    if (cropInstances.length === 0) {
      alert("Please upload and crop at least one image.");
      return;
    }

    let completed = 0;

    cropInstances.forEach((cropper, index) => {
      cropper.getCroppedCanvas({
        width: 600,
        height: 600,
      }).toBlob(function (blob) {
        const reader = new FileReader();
        reader.onloadend = function () {
          croppedImagesData.push(reader.result);
          completed++;

          if (completed === cropInstances.length) {
            document.getElementById('croppedImagesData').value = JSON.stringify(croppedImagesData);
            e.target.submit();  // safe submit
          }
        };
        reader.readAsDataURL(blob);
      }, 'image/jpeg');
    });
  });

</script>

{% endblock %}