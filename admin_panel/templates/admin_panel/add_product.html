{% extends 'admin_panel/base.html' %}
{% block content %}

<link href="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.13/cropper.min.css" rel="stylesheet" />

<div class="max-w-2xl mx-auto p-6 bg-white shadow-md rounded-md mt-10">
  <h2 class="text-2xl font-semibold mb-6 text-center">Add New Product</h2>

  {% if messages %}
  <div class="mb-4">
    {% for message in messages %}
    <p class="text-sm text-{{ message.tags }}-600">{{ message }}</p>
    {% endfor %}
  </div>
  {% endif %}

  <form method="post" enctype="multipart/form-data" class="space-y-5" id="productForm">
    {% csrf_token %}

    <div>
      <label class="block mb-1 font-medium">Product Name</label>
      <input type="text" name="name" placeholder="Product Name" class="w-full px-4 py-2 border rounded" required />
    </div>

    <div>
      <label class="block mb-1 font-medium">Category</label>
      <select name="category" class="w-full px-4 py-2 border rounded" required>
        {% for category in categories %}
        <option value="{{ category.id }}">{{ category.name }}</option>
        {% endfor %}
      </select>
    </div>

    <div>
      <label class="block mb-1 font-medium">Description</label>
      <textarea name="description" rows="3" class="w-full px-4 py-2 border rounded" required></textarea>
    </div>

    <div class="grid grid-cols-2 gap-4">
      <div>
        <label class="block mb-1 font-medium">Min Age (months)</label>
        <input type="number" name="min_age" min="0" max="36" class="w-full px-4 py-2 border rounded" />
      </div>
      <div>
        <label class="block mb-1 font-medium">Max Age (months)</label>
        <input type="number" name="max_age" min="0" max="36" class="w-full px-4 py-2 border rounded" />
      </div>
    </div>

    <div>
      <label class="block mb-1 font-medium">Gender</label>
      <select name="gender" class="w-full px-4 py-2 border rounded">
        <option value="Unisex">Unisex</option>
        <option value="Male">Male</option>
        <option value="Female">Female</option>
      </select>
    </div>

    <div class="grid grid-cols-2 gap-4">
      <div>
        <label class="block mb-1 font-medium">Price (â‚¹)</label>
        <input type="number" name="price" step="0.01" min="0" class="w-full px-4 py-2 border rounded" required />
      </div>
      <div>
        <label class="block mb-1 font-medium">Stock</label>
        <input type="number" name="stock" min="0" class="w-full px-4 py-2 border rounded" required />
      </div>
    </div>

    <!-- Image Cropper Section -->
    <div>
      <label class="block mb-1 font-medium">Product Images (Crop and upload 3 images)</label>
      <input type="file" id="imageInput" accept="image/*" class="w-full px-4 py-2 border rounded mb-2" />
      <div id="cropperContainer" class="w-64 h-64 mx-auto mb-2 hidden">
        <img id="imagePreview" class="object-contain w-full h-full rounded shadow" />
      </div>
      <div class="flex gap-2 mb-2">
        <button id="addCroppedBtn" type="button" class="bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700">Add
          Cropped Image</button>
      </div>
      <div id="croppedImagesPreview" class="flex gap-4 mb-2"></div>
      <!-- Hidden inputs for cropped images -->
      <div id="croppedInputs"></div>
      <p class="text-sm text-gray-500">You must upload exactly 3 cropped images. Repeat the process for each image.</p>
    </div>

    <div class="flex justify-end">
      <button type="submit" class="bg-green-600 text-white px-6 py-2 rounded hover:bg-green-700">Add Product</button>
    </div>
  </form>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.13/cropper.min.js"></script>
<script>
  let cropper;
  let croppedImages = [];
  const imageInput = document.getElementById('imageInput');
  const imagePreview = document.getElementById('imagePreview');
  const cropperContainer = document.getElementById('cropperContainer');
  const addCroppedBtn = document.getElementById('addCroppedBtn');
  const croppedImagesPreview = document.getElementById('croppedImagesPreview');
  const croppedInputs = document.getElementById('croppedInputs');
  const productForm = document.getElementById('productForm');

  imageInput.addEventListener('change', function (e) {
    const file = e.target.files[0];
    if (file) {
      cropperContainer.classList.remove('hidden');
      const url = URL.createObjectURL(file);
      imagePreview.src = url;
      if (cropper) cropper.destroy();
      cropper = new Cropper(imagePreview, {
        aspectRatio: 1,
        viewMode: 1,
        autoCropArea: 1,
      });
    }
  });

  addCroppedBtn.addEventListener('click', function (e) {
    e.preventDefault();
    if (cropper && croppedImages.length < 3) {
      cropper.getCroppedCanvas({ width: 600, height: 600 }).toBlob(function (blob) {
        const file = new File([blob], `cropped${croppedImages.length + 1}.jpg`, { type: "image/jpeg" });
        croppedImages.push(file);

        // Preview
        const imgElem = document.createElement('img');
        imgElem.src = URL.createObjectURL(file);
        imgElem.className = "w-20 h-20 object-cover rounded border";
        croppedImagesPreview.appendChild(imgElem);

        // Hidden input for form
        const inputElem = document.createElement('input');
        inputElem.type = "file";
        inputElem.name = "images";
        inputElem.files = (function () {
          const dt = new DataTransfer();
          dt.items.add(file);
          return dt.files;
        })();
        inputElem.className = "hidden";
        croppedInputs.appendChild(inputElem);

        // Reset for next image
        cropper.destroy();
        cropperContainer.classList.add('hidden');
        imageInput.value = "";
      }, 'image/jpeg', 0.95);
    }
  });

  // Prevent form submission unless 3 images are added
  productForm.addEventListener('submit', function (e) {
    if (croppedImages.length !== 3) {
      e.preventDefault();
      alert("Please crop and add exactly 3 images before submitting.");
    }
  });
</script>

{% endblock %}