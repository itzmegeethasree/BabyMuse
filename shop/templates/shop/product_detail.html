{% extends 'core/base.html' %}
{% load static %}

{% block content %}
<div class="max-w-6xl mx-auto px-6 py-8 grid md:grid-cols-2 gap-8">

  <!-- Product Images -->
  <div>
    <!-- Breadcrumb -->
    <nav class="mb-4 text-sm text-gray-500">
      <a href="{% url 'home' %}" class="hover:text-pink-600">Home</a> /
      <a href="{% url 'shop' %}" class="hover:text-pink-600">Shop</a> /
      <span class="text-pink-600 font-medium">{{ product.name }}</span>
    </nav>

    <!-- Zoomable Main Image -->
    <div class="border rounded-lg overflow-hidden mb-4 relative">
      <img id="main-image" src="{{ images.0.image.url }}" alt="{{ product.name }}"
        class="w-full h-[400px] object-contain transition-transform duration-300 ease-in-out"
        onmousemove="zoomImage(event)" onmouseleave="resetZoom()" />
    </div>

    <!-- Thumbnails -->
    <div class="flex gap-4">
      {% for image in images %}
      <img src="{{ image.image.url }}" alt="Thumb {{ forloop.counter }}"
        class="w-24 h-24 object-cover cursor-pointer border rounded-lg hover:ring-2 hover:ring-pink-500"
        onclick="changeMainImage('{{ image.image.url }}')" />
      {% endfor %}
    </div>
  </div>

  <!-- Product Info -->
  <div>
    <h1 class="text-3xl font-bold mb-2">{{ product.name }}</h1>

    <!-- Rating -->
    <div class="flex items-center gap-2 mb-2">
      <div>
        {% for i in "12345" %}
        {% if avg_rating >= forloop.counter %}
        ‚≠ê
        {% elif avg_rating >= forloop.counter0|add:"0.5" %}
        ‚≠ê
        {% else %}
        ‚òÜ
        {% endif %}
        {% endfor %}
      </div>
      <span class="text-gray-600 text-sm">({{ total_reviews }} reviews)</span>
    </div>

    <!-- Price + Discount -->
    {% if product.discount_price %}
    <div class="text-2xl text-pink-600 font-semibold">
      ‚Çπ{{ product.discount_price }}
      <del class="text-gray-500 text-lg ml-2">‚Çπ{{ product.price }}</del>
    </div>
    {% else %}
    <div class="text-2xl text-pink-600 font-semibold">‚Çπ{{ product.price }}</div>
    {% endif %}

    <!-- Stock Info -->
    {% if product.stock > 0 %}
    <p class="mt-2 text-green-600">In Stock: {{ product.stock }}</p>
    {% else %}
    <p class="mt-2 text-red-500 font-semibold">Out of Stock</p>
    {% endif %}

    <!-- Description -->
    <p class="mt-4 text-gray-700 leading-relaxed">{{ product.description }}</p>

    <!-- Action Buttons -->
    {% if product.stock > 0 %}
    <div class="flex gap-4 mt-6">
      <button id="add-to-cart-btn" class="bg-green-600 text-white px-5 py-2 rounded hover:bg-green-700 transition"
        data-product-id="{{ product.id }}">üõí Add to Cart</button>

      <button id="add-to-wishlist-btn" class="bg-pink-500 text-white px-5 py-2 rounded hover:bg-pink-600 transition"
        data-product-id="{{ product.id }}">‚ù§Ô∏è Add to Wishlist</button>
    </div>
    {% else %}
    <div class="mt-6 p-4 bg-yellow-100 border-l-4 border-yellow-500 text-yellow-700">
      ‚ö†Ô∏è This product is currently unavailable or sold out.
    </div>
    {% endif %}
  </div>
</div>

<!-- Toast -->
<div id="toast"
  class="fixed top-5 right-5 px-4 py-2 rounded shadow hidden z-50 bg-green-100 text-green-800 border border-green-400">
</div>

<!-- Zoom + AJAX Logic -->
<script>
  function changeMainImage(url) {
    const img = document.getElementById("main-image");
    img.src = url;
    img.style.transform = "scale(1)";
  }

  function zoomImage(e) {
    const img = e.target;
    const rect = img.getBoundingClientRect();
    const x = e.clientX - rect.left;
    const y = e.clientY - rect.top;
    const xPercent = x / rect.width * 100;
    const yPercent = y / rect.height * 100;
    img.style.transformOrigin = `${xPercent}% ${yPercent}%`;
    img.style.transform = "scale(2)";
  }

  function resetZoom() {
    const img = document.getElementById("main-image");
    img.style.transform = "scale(1)";
  }

  function showToast(message, success = true) {
    const toast = document.getElementById("toast");
    toast.innerText = message;
    toast.className = `fixed top-5 right-5 px-4 py-2 rounded shadow z-50 ${success ? 'bg-green-100 text-green-800 border-green-400' : 'bg-red-100 text-red-800 border-red-400'}`;
    toast.classList.remove("hidden");
    setTimeout(() => toast.classList.add("hidden"), 3000);
  }

  document.addEventListener("DOMContentLoaded", function () {
    const cartBtn = document.getElementById("add-to-cart-btn");
    const wishlistBtn = document.getElementById("add-to-wishlist-btn");

    if (cartBtn) {
      cartBtn.addEventListener("click", function () {
        const productId = this.dataset.productId;
        fetch("{% url 'ajax_add_to_cart' %}", {
          method: "POST",
          headers: {
            "X-CSRFToken": "{{ csrf_token }}",
            "Content-Type": "application/x-www-form-urlencoded"
          },
          body: `product_id=${productId}`
        })
          .then(res => res.json())
          .then(data => {
            if (data.status === 'success') {
              showToast("Added to cart!");
              document.getElementById("cart-count").innerText = data.cart_count;
            } else {
              showToast(data.message || "Add to cart failed", false);
            }
          });
      });
    }

    if (wishlistBtn) {
      wishlistBtn.addEventListener("click", function () {
        const productId = this.dataset.productId;
        fetch("{% url 'ajax_add_to_wishlist' %}", {
          method: "POST",
          headers: {
            "X-CSRFToken": "{{ csrf_token }}",
            "Content-Type": "application/x-www-form-urlencoded"
          },
          body: `product_id=${productId}`
        })
          .then(res => res.json())
          .then(data => {
            if (data.status === 'added') {
              showToast("Added to wishlist!");
            } else {
              showToast("Already in wishlist", false);
            }
          });
      });
    }
  });
</script>
{% endblock %}