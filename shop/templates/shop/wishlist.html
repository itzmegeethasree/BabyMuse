{% extends 'core/base.html' %}
{% load static %}

{% block content %}
<div class="max-w-4xl mx-auto p-6">
  <h2 class="text-3xl font-bold mb-6">â¤ï¸ My Wishlist</h2>

  {% if wishlist_items %}
  <ul class="space-y-4">
    {% for item in wishlist_items %}
    <li class="flex justify-between items-center border p-4 rounded-md shadow-sm"
      id="wishlist-item-{{ item.product.id }}">
      <!-- Product Info -->
      <div class="flex gap-4 items-center">
        <img src="{{ item.product.primary_image }}" alt="{{ item.product.name }}"
          class="w-24 h-24 object-cover rounded-md border">
        <div>
          <h3 class="font-semibold text-lg">{{ item.product.name }}</h3>
          <p class="text-gray-700">â‚¹{{ item.product.price }}</p>
        </div>
      </div>

      <!-- Actions -->
      <div class="text-right space-x-3">
        <button class="add-to-cart-btn text-green-600 hover:underline font-medium"
          data-product-id="{{ item.product.id }}">ğŸ›’ Add to Cart</button>
        <button class="remove-from-wishlist-btn text-red-600 hover:underline font-medium"
          data-product-id="{{ item.product.id }}">ğŸ—‘ï¸ Remove</button>
      </div>
    </li>
    {% endfor %}
  </ul>
  {% else %}
  <p class="text-gray-600 text-lg">You have no items in your wishlist.</p>
  {% endif %}
</div>

<!-- Toast Notification -->
<div id="toast"
  class="fixed top-5 right-5 hidden bg-green-100 text-green-800 border border-green-400 px-4 py-2 rounded shadow z-50">
</div>

<!-- Scripts -->
<script>
  document.addEventListener("DOMContentLoaded", function () {
    const csrfToken = "{{ csrf_token }}";

    // âœ… Show toast messages
    function showToast(msg, isError = false) {
      const toast = document.getElementById("toast");
      toast.innerText = msg;
      toast.className = `fixed top-5 right-5 px-4 py-2 rounded shadow z-50 border ${isError ? "bg-red-100 text-red-800 border-red-400" : "bg-green-100 text-green-800 border-green-400"
        }`;
      toast.classList.remove("hidden");
      setTimeout(() => toast.classList.add("hidden"), 2000);
    }
    function updateCartCount(count) {
      const el = document.getElementById("cart-count");
      if (el) {
        el.innerText = count;
        if (count > 0) el.classList.remove("hidden");
        else el.classList.add("hidden");
      }
    }
    function updateWishlistCount(count) {
      const el = document.getElementById("wish-count");
      if (el) {
        el.innerText = count;
        if (count > 0) el.classList.remove("hidden");
        else el.classList.add("hidden");
      }
    }


    // ğŸ›’ Add to Cart
    document.querySelectorAll(".add-to-cart-btn").forEach(button => {
      button.addEventListener("click", function () {
        const productId = this.dataset.productId;

        fetch("{% url 'ajax_add_to_cart' %}", {
          method: "POST",
          headers: {
            "X-CSRFToken": csrfToken,
            "Content-Type": "application/x-www-form-urlencoded"
          },
          body: `product_id=${productId}`
        })
          .then(res => res.json())
          .then(data => {
            if (data.status === 'success') {
              updateCartCount(data.cart_count);
              showToast("âœ… Added to cart");
            } else {
              showToast(data.message || "âŒ Could not add to cart", true);
            }
          });
      });
    });

    // âŒ Remove from Wishlist
    document.querySelectorAll(".remove-from-wishlist-btn").forEach(button => {
      button.addEventListener("click", function () {
        const productId = this.dataset.productId;

        fetch("{% url 'ajax_remove_from_wishlist' %}", {
          method: "POST",
          headers: {
            "X-CSRFToken": csrfToken,
            "Content-Type": "application/json"
          },
          body: JSON.stringify({ product_id: productId })
        })
          .then(res => res.json())
          .then(data => {
            if (data.status === 'success') {
              document.getElementById(`wishlist-item-${productId}`).remove();
              updateWishlistCount(data.wishlist_count);

              showToast("ğŸ—‘ï¸ Removed from wishlist");
            } else {
              showToast("âš ï¸ Error removing item", true);
            }
          });
      });
    });
  });
</script>
{% endblock %}