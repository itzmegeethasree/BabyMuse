{% extends 'core/base.html' %}
{% load static %}

{% block content %}
<div class="max-w-3xl mx-auto p-8 text-center">
    <h2 class="text-3xl font-bold mb-6">Complete Your Payment</h2>


    <div class="bg-white border p-6 rounded shadow text-left space-y-4">
        <p><strong>Order ID:</strong> {{ order.id }}</p>
        <p><strong>Total Amount:</strong> â‚¹{{ order.total_price }}</p>
        <p><strong>Payment Method:</strong> Razorpay</p>
    </div>

    <button id="rzp-button" class="mt-6 bg-green-600 hover:bg-green-700 text-white font-semibold px-6 py-3 rounded">
        Pay Now with Razorpay
    </button>
</div>

<script src="https://checkout.razorpay.com/v1/checkout.js"></script>

<script>

    const options = {
        key: "{{ razorpay_key }}",
        amount: "{{ amount }}",
        currency: "INR",
        name: "BabyMuse",
        description: "Payment for Order #{{ order.id }}",
        order_id: "{{ razorpay_order_id }}",

        handler: function (response) {
            fetch("{% url 'orders:razorpay_success' %}", {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': '{{ csrf_token }}'
                },
                body: JSON.stringify({
                    razorpay_payment_id: response.razorpay_payment_id,
                    razorpay_order_id: response.razorpay_order_id,
                    razorpay_signature: response.razorpay_signature,
                    order_id: "{{ order.id }}"
                })
            })
                .then(res => res.json())
                .then(data => {
                    window.location.href = data.redirect_url;
                });
        },

        prefill: {
            name: "{{ user_name }}",
            email: "{{ user_email }}"
        },

        theme: {
            color: "#f97316"
        },

        modal: {
            ondismiss: function () {
                fetch("{% url 'orders:mark_payment_failed' %}", {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': '{{ csrf_token }}'
                    },
                    body: JSON.stringify({
                        order_id: "{{ order.id }}"
                    })
                })
                    .then(res => res.json())
                    .then(data => {
                        window.location.href = data.redirect_url;
                    });
            }
        }
    };

    const rzp = new Razorpay(options);
    document.getElementById('rzp-button').onclick = function (e) {
        rzp.open();
        e.preventDefault();
    }
</script>
{% endblock %}